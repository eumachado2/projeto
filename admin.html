<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Valida√ß√£o</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h1 { margin: 0; color: #333; }
        .btn-logout { background-color: #7f8c8d; color: white; padding: 8px 15px; text-decoration: none; border-radius: 5px; font-weight: bold;}
        .btn-logout:hover { background-color: #636e72; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .card h3 { margin: 0; font-size: 14px; color: #666; }
        .card p { margin: 10px 0 0; font-size: 24px; font-weight: bold; color: #2c3e50; }
        .c-green p { color: #27ae60; } .c-yellow p { color: #f39c12; } .c-blue p { color: #2980b9; }

        /* Sorteio Box */
        .sorteio-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .btn-sortear {
            background: #ffeb3b; color: #333; border: none; padding: 10px 25px; font-size: 18px; font-weight: bold;
            border-radius: 50px; cursor: pointer; box-shadow: 0 4px 0 #fbc02d; transition: 0.2s;
        }
        .btn-sortear:hover { transform: translateY(2px); box-shadow: 0 2px 0 #fbc02d; }
        .btn-sortear:active { transform: translateY(4px); box-shadow: none; }
        #resultadoSorteio { margin-top: 15px; font-size: 22px; font-weight: bold; min-height: 30px; }

        /* Tabela */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); font-size: 14px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background-color: #2c3e50; color: white; }
        tr:hover { background-color: #f9f9f9; }
        .pendente-box { background-color: #fff3cd; color: #856404; padding: 8px; border-radius: 5px; border: 1px solid #ffeeba; display: flex; flex-direction: column; gap: 5px; }
        .confirmado-box { background-color: #d4edda; color: #155724; padding: 8px; border-radius: 5px; border: 1px solid #c3e6cb; }
        .agendamento-box { background-color: #e3f2fd; color: #0d47a1; padding: 5px; border-radius: 4px; font-size: 12px; margin-bottom: 2px; border: 1px solid #bbdefb; }
        
        .btn { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;}
        .btn-check { background-color: #28a745; color: white; }
        .btn-deny { background-color: #dc3545; color: white; }
        .btn-edit { background-color: #17a2b8; color: white; }
        .btn-del { background-color: #34495e; color: white; } .btn-del:hover { background-color: #2c3e50; }
        .btn-refresh { background-color: #3498db; color: white; padding: 10px 20px; font-size: 14px; margin-bottom: 20px;}
        .btn-reset { background-color: #e74c3c; color: white; padding: 10px 20px; font-size: 14px; margin-top: 20px;}

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 10px; width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .close { float: right; cursor: pointer; font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Valida√ß√£o de Compras</h1>
            <a href="/api/admin/logout" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </div>
        
        <div class="sorteio-box">
            <h2>üèÜ Sortear Ganhador</h2>
            <p style="font-size:14px; opacity:0.9">Sorteia aleatoriamente entre as rifas com status "Vendido"</p>
            <button class="btn-sortear" onclick="realizarSorteio()">üé≤ REALIZAR SORTEIO</button>
            <div id="resultadoSorteio"></div>
        </div>

        <button onclick="carregarDados()" class="btn btn-refresh"><i class="fas fa-sync"></i> Atualizar Dados</button>

        <div class="stats-grid">
            <div class="card c-green"><h3>Confirmadas</h3><p id="statsConfirmadas">-</p></div>
            <div class="card c-yellow"><h3>Aguardando</h3><p id="statsPendentes">-</p></div>
            <div class="card c-blue"><h3>Dispon√≠veis</h3><p id="statsDisponiveis">-</p></div>
            <div class="card"><h3>Caixa</h3><p id="statsDinheiro">R$ 0,00</p></div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="5%">ID</th>
                        <th width="20%">Usu√°rio</th>
                        <th width="20%">‚ö†Ô∏è Pendentes</th>
                        <th width="20%">‚úÖ Confirmados</th>
                        <th width="20%">üìÖ Agendamento</th>
                        <th width="15%">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="tabelaUsuarios"></tbody>
            </table>
        </div>

        <button onclick="resetarSistema()" class="btn btn-reset">RESETAR TUDO</button>
    </div>

    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <h2>Editar Usu√°rio</h2>
            <input type="hidden" id="editId">
            <div class="form-group"><label>Nome</label><input type="text" id="editNome"></div>
            <div class="form-group"><label>Email</label><input type="email" id="editEmail"></div>
            <div class="form-group"><label>Senha</label><input type="text" id="editSenha"></div>
            <div style="text-align:right">
                <button class="btn btn-check" onclick="salvarEdicao()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        async function carregarDados() {
            try {
                const response = await fetch('/api/admin/dados');
                if (response.status === 403 || response.redirected) { window.location.href = '/admin_login.html'; return; }
                const data = await response.json();

                if (data.sucesso) {
                    document.getElementById('statsConfirmadas').innerText = data.stats.vendidas;
                    document.getElementById('statsPendentes').innerText = data.stats.pendentes;
                    document.getElementById('statsDisponiveis').innerText = data.stats.disponiveis;
                    document.getElementById('statsDinheiro').innerText = data.stats.arrecadacao_real.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                    const tbody = document.getElementById('tabelaUsuarios');
                    tbody.innerHTML = '';

                    data.usuarios.forEach(user => {
                        const pendentes = user.numeros_pendentes || '';
                        const confirmados = user.numeros_confirmados || '';
                        const agendamentos = user.datas_reservadas || '';
                        
                        let htmlPendente = '<span style="color:#aaa;">-</span>';
                        if (pendentes) {
                            htmlPendente = `
                                <div class="pendente-box">
                                    <strong>${pendentes}</strong>
                                    <div>
                                        <button class="btn btn-check" onclick="validarCompra(${user.id}, '${pendentes}', 'aprovar')" title="Aprovar"><i class="fas fa-check"></i></button>
                                        <button class="btn btn-deny" onclick="validarCompra(${user.id}, '${pendentes}', 'rejeitar')" title="Rejeitar"><i class="fas fa-trash"></i></button>
                                    </div>
                                </div>`;
                        }
                        
                        let htmlConfirmado = confirmados ? `<div class="confirmado-box">${confirmados}</div>` : '<span style="color:#aaa;">-</span>';
                        
                        // L√≥gica para exibir os dias de forma bonita
                        let htmlAgendamento = '<span style="color:#aaa;">-</span>';
                        if (agendamentos) {
                            htmlAgendamento = agendamentos.split(',').map(dia => `<div class="agendamento-box">üóìÔ∏è ${dia.trim()}</div>`).join('');
                        }

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${user.id}</td>
                            <td><strong>${user.nome}</strong><br><span style="font-size:12px; color:#666;">${user.email}</span></td>
                            <td>${htmlPendente}</td>
                            <td>${htmlConfirmado}</td>
                            <td>${htmlAgendamento}</td>
                            <td>
                                <button class="btn btn-edit" onclick='abrirModal(${JSON.stringify(user)})' title="Editar"><i class="fas fa-pen"></i></button>
                                <button class="btn btn-del" onclick="excluirUsuario(${user.id}, '${user.nome}')" title="Excluir Usu√°rio"><i class="fas fa-user-times"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) { console.error(error); }
        }

        async function validarCompra(userId, numerosStr, acao) {
            const endpoint = acao === 'aprovar' ? '/api/admin/aprovar_compra' : '/api/admin/rejeitar_compra';
            if (!confirm(acao === 'aprovar' ? "Confirmar Pagamento?" : "Cancelar compra?")) return;
            await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usuario_id: userId, numeros: numerosStr }) });
            carregarDados();
        }

        async function excluirUsuario(id, nome) {
            if (confirm(`ATEN√á√ÉO: Tem certeza que deseja excluir o usu√°rio "${nome}"?\n\n- Todas as rifas compradas voltar√£o a ficar dispon√≠veis.\n- O agendamento dele ser√° apagado.\n- O cadastro sumir√°.`)) {
                const res = await fetch('/api/admin/excluir_usuario', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id: id})});
                const json = await res.json();
                if(json.sucesso) { alert('Usu√°rio exclu√≠do!'); carregarDados(); } else { alert('Erro: ' + json.msg); }
            }
        }

        async function realizarSorteio() {
            const div = document.getElementById('resultadoSorteio');
            div.innerHTML = "Sorteando... ü•Å";
            setTimeout(async () => {
                const res = await fetch('/api/admin/sortear', { method: 'POST' });
                const json = await res.json();
                if (json.sucesso) {
                    div.innerHTML = `üéâ O Ganhador √©: <strong>${json.ganhador.nome}</strong> (Rifa: ${json.ganhador.numero}) üéâ`;
                    alert(`GANHADOR ENCONTRADO!\n\nNome: ${json.ganhador.nome}\nEmail: ${json.ganhador.email}\nN√∫mero Sorteado: ${json.ganhador.numero}`);
                } else {
                    div.innerHTML = "‚ùå " + json.msg;
                }
            }, 1000);
        }

        const modal = document.getElementById("modalEditar");
        function abrirModal(user) {
            document.getElementById('editId').value = user.id;
            document.getElementById('editNome').value = user.nome;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editSenha').value = user.senha;
            modal.style.display = "flex";
        }
        function fecharModal() { modal.style.display = "none"; }
        async function salvarEdicao() {
            const dados = { id: document.getElementById('editId').value, nome: document.getElementById('editNome').value, email: document.getElementById('editEmail').value, senha: document.getElementById('editSenha').value };
            const res = await fetch('/api/admin/atualizar_usuario', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) });
            const json = await res.json();
            if(json.sucesso) { alert('Salvo!'); fecharModal(); carregarDados(); } else { alert('Erro: ' + json.msg); }
        }

        async function resetarSistema() {
            if(confirm("Tem certeza absoluta? Isso apaga todas as vendas.")) {
                await fetch('/api/admin/resetar', {method: 'POST'});
                carregarDados();
                alert('Sistema resetado.');
            }
        }

        window.onclick = function(e) { if(e.target == modal) fecharModal(); }
        carregarDados();
    </script>
</body>
</html>