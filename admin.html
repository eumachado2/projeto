<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Validação</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
        }
        .container { max-width: 1300px; margin: 0 auto; }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center;
        }
        .card h3 { margin: 0; font-size: 14px; color: #666; }
        .card p { margin: 10px 0 0; font-size: 24px; font-weight: bold; color: #2c3e50; }
        
        .c-green p { color: #27ae60; }
        .c-yellow p { color: #f39c12; }
        .c-blue p { color: #2980b9; }

        /* Tabela */
        .table-container { overflow-x: auto; }
        table {
            width: 100%; border-collapse: collapse; background: white;
            border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background-color: #2c3e50; color: white; }
        tr:hover { background-color: #f9f9f9; }

        /* Badges e Colunas Especiais */
        .pendente-box {
            background-color: #fff3cd; color: #856404; padding: 8px;
            border-radius: 5px; border: 1px solid #ffeeba;
            display: flex; flex-direction: column; gap: 5px;
        }
        .confirmado-box {
            background-color: #d4edda; color: #155724; padding: 8px;
            border-radius: 5px; border: 1px solid #c3e6cb;
        }
        
        /* Botões */
        .btn { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px;}
        .btn-check { background-color: #28a745; color: white; }
        .btn-check:hover { background-color: #218838; }
        .btn-deny { background-color: #dc3545; color: white; }
        .btn-deny:hover { background-color: #c82333; }
        
        .btn-edit { background-color: #17a2b8; color: white; }
        .btn-refresh { background-color: #3498db; color: white; padding: 10px 20px; font-size: 14px; margin-bottom: 20px;}
        .btn-reset { background-color: #e74c3c; color: white; padding: 10px 20px; font-size: 14px; margin-top: 20px;}

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 10px; width: 400px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .close { float: right; cursor: pointer; font-size: 24px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Validação de Compras</h1>
        <button onclick="carregarDados()" class="btn btn-refresh"><i class="fas fa-sync"></i> Atualizar</button>

        <div class="stats-grid">
            <div class="card c-green">
                <h3>Confirmadas</h3>
                <p id="statsConfirmadas">-</p>
            </div>
            <div class="card c-yellow">
                <h3>Aguardando Validação</h3>
                <p id="statsPendentes">-</p>
            </div>
            <div class="card c-blue">
                <h3>Disponíveis</h3>
                <p id="statsDisponiveis">-</p>
            </div>
            <div class="card">
                <h3>Caixa (Confirmado)</h3>
                <p id="statsDinheiro">R$ 0,00</p>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="5%">ID</th>
                        <th width="20%">Usuário</th>
                        <th width="35%">⚠️ Pendentes (Requer Ação)</th>
                        <th width="30%">✅ Confirmados</th>
                        <th width="10%">Ações</th>
                    </tr>
                </thead>
                <tbody id="tabelaUsuarios">
                    </tbody>
            </table>
        </div>

        <button onclick="resetarSistema()" class="btn btn-reset">RESETAR TUDO</button>
    </div>

    <div id="modalEditar" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal()">&times;</span>
            <h2>Editar Usuário</h2>
            <input type="hidden" id="editId">
            <div class="form-group"><label>Nome</label><input type="text" id="editNome"></div>
            <div class="form-group"><label>Email</label><input type="email" id="editEmail"></div>
            <div class="form-group"><label>Senha</label><input type="text" id="editSenha"></div>
            <div style="text-align:right">
                <button class="btn btn-check" onclick="salvarEdicao()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        async function carregarDados() {
            try {
                const response = await fetch('/api/admin/dados');
                const data = await response.json();

                if (data.sucesso) {
                    // Stats
                    document.getElementById('statsConfirmadas').innerText = data.stats.vendidas;
                    document.getElementById('statsPendentes').innerText = data.stats.pendentes;
                    document.getElementById('statsDisponiveis').innerText = data.stats.disponiveis;
                    document.getElementById('statsDinheiro').innerText = data.stats.arrecadacao_real.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                    const tbody = document.getElementById('tabelaUsuarios');
                    tbody.innerHTML = '';

                    data.usuarios.forEach(user => {
                        const pendentes = user.numeros_pendentes || '';
                        const confirmados = user.numeros_confirmados || '';

                        // Lógica HTML da coluna Pendente
                        let htmlPendente = '<span style="color:#aaa;">Nada pendente</span>';
                        if (pendentes) {
                            htmlPendente = `
                                <div class="pendente-box">
                                    <strong>Números: ${pendentes}</strong>
                                    <div style="margin-top:5px;">
                                        <button class="btn btn-check" onclick="validarCompra(${user.id}, '${pendentes}', 'aprovar')">
                                            <i class="fas fa-check"></i> Confirmar Pagamento
                                        </button>
                                        <button class="btn btn-deny" onclick="validarCompra(${user.id}, '${pendentes}', 'rejeitar')">
                                            <i class="fas fa-trash"></i> Não pagou
                                        </button>
                                    </div>
                                </div>
                            `;
                        }

                        // Lógica HTML da coluna Confirmado
                        let htmlConfirmado = '<span style="color:#aaa;">Nada confirmado</span>';
                        if (confirmados) {
                            htmlConfirmado = `<div class="confirmado-box">${confirmados}</div>`;
                        }

                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${user.id}</td>
                            <td>
                                <strong>${user.nome}</strong><br>
                                <span style="font-size:12px; color:#666;">${user.email}</span>
                            </td>
                            <td>${htmlPendente}</td>
                            <td>${htmlConfirmado}</td>
                            <td>
                                <button class="btn btn-edit" onclick='abrirModal(${JSON.stringify(user)})'><i class="fas fa-pen"></i></button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) { console.error(error); }
        }

        async function validarCompra(userId, numerosStr, acao) {
            const endpoint = acao === 'aprovar' ? '/api/admin/aprovar_compra' : '/api/admin/rejeitar_compra';
            const pergunta = acao === 'aprovar' 
                ? "Confirmar que o pagamento foi recebido?" 
                : "Cancelar essa compra e liberar os números?";

            if (!confirm(pergunta)) return;

            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ usuario_id: userId, numeros: numerosStr })
                });
                const json = await res.json();
                if (json.sucesso) {
                    carregarDados();
                } else {
                    alert('Erro: ' + json.msg);
                }
            } catch (e) { alert('Erro na requisição'); }
        }

        // --- Edição de Usuário ---
        const modal = document.getElementById("modalEditar");
        function abrirModal(user) {
            document.getElementById('editId').value = user.id;
            document.getElementById('editNome').value = user.nome;
            document.getElementById('editEmail').value = user.email;
            document.getElementById('editSenha').value = user.senha;
            modal.style.display = "flex";
        }
        function fecharModal() { modal.style.display = "none"; }
        
        async function salvarEdicao() {
            const dados = {
                id: document.getElementById('editId').value,
                nome: document.getElementById('editNome').value,
                email: document.getElementById('editEmail').value,
                senha: document.getElementById('editSenha').value
            };
            const res = await fetch('/api/admin/atualizar_usuario', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados)
            });
            const json = await res.json();
            if(json.sucesso) { alert('Salvo!'); fecharModal(); carregarDados(); }
            else { alert('Erro: ' + json.msg); }
        }

        async function resetarSistema() {
            if(prompt("Digite 'admin' para apagar TUDO:") === 'admin') {
                await fetch('/api/admin/resetar', {method: 'POST'});
                carregarDados();
                alert('Sistema resetado.');
            }
        }

        window.onclick = function(e) { if(e.target == modal) fecharModal(); }
        carregarDados();
    </script>
</body>
</html>