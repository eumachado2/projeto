<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css"> <title>Redefinir Senha - Rifa da Casa</title>
</head>
<body>
    <main class="container">
        <form id="formNovaSenha">
            <h1>Nova Senha</h1>
            <p style="color: #aaa; margin-bottom: 20px; font-size: 14px;">Crie uma senha forte e segura.</p>

            <div class="input-box">
                <input id="senha1" placeholder="Nova Senha" type="password" required>
                <i class="bx bxs-lock-alt"></i>
            </div>

            <div class="input-box">
                <input id="senha2" placeholder="Repita a Senha" type="password" required>
                <i class="bx bxs-lock-open-alt"></i>
            </div>
            
            <button type="submit" class="Cadastro">Salvar Senha</button>

            <div class="register-link">
                <p id="msg" style="margin-top: 20px; font-weight: bold;"></p>
                <p><a href="/index.html">Voltar ao Login</a></p>
            </div>
        </form>
    </main>

    <script>
        document.getElementById("formNovaSenha").addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const s1 = document.getElementById("senha1").value;
            const s2 = document.getElementById("senha2").value;
            const msgEl = document.getElementById("msg");

            // Lógica para pegar o token da URL amigável: /redefinir-senha/TOKEN
            const pathParts = window.location.pathname.split('/');
            const token = pathParts[pathParts.length - 1];

            if(s1 !== s2) {
                msgEl.innerText = "As senhas não coincidem!";
                msgEl.style.color = "#ff4444";
                return;
            }

            msgEl.innerText = "Processando...";
            msgEl.style.color = "white";

            try {
                const response = await fetch('/api/reset-password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        token: token, 
                        senha: s1 
                    })
                });

                const data = await response.json();

                if(data.sucesso) {
                    msgEl.innerText = "Senha alterada com sucesso! Redirecionando...";
                    msgEl.style.color = "#28a745";
                    
                    // Aguarda 2 segundos e manda para o login
                    setTimeout(() => {
                        window.location.href = "/index.html";
                    }, 2500);
                } else {
                    msgEl.innerText = data.msg;
                    msgEl.style.color = "#ff4444";
                }
            } catch (error) {
                msgEl.innerText = "Erro ao conectar com o servidor.";
                msgEl.style.color = "#ff4444";
            }
        });
    </script>
</body>
</html>